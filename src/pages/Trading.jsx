import { useState, useEffect, useRef } from 'react';
import TradingChart from '../components/TradingChart';
import CurrencyModal from '../components/CurrencyModal';
import { usePriceContext } from '../contexts/PriceContext';
import { generateRealisticHistoricalData, generateTokenHistoricalData } from '../utils/marketDataGenerator';

const Trading = () => {
  const { currentPrice, updatePrice } = usePriceContext();
  const [tradeAmount, setTradeAmount] = useState(1);
  const [payout] = useState(1.75);
  const [chartData, setChartData] = useState([]);
  const [activeTrades, setActiveTrades] = useState([]);
  const [balance, setBalance] = useState(1000); // ÂàùÂßã‰ΩôÈ¢ù1000
  const [selectedCurrency, setSelectedCurrency] = useState('USDT');
  const [showCurrencyModal, setShowCurrencyModal] = useState(false);
  const [showTokenList, setShowTokenList] = useState(true); // ÈªòËÆ§ÊòæÁ§∫tokenÂàóË°®
  const [selectedToken, setSelectedToken] = useState(null);
  const [realTimeTokens, setRealTimeTokens] = useState({}); // Â≠òÂÇ®ÂÆûÊó∂‰ª∑Ê†ºÊï∞ÊçÆ
  const [chartType, setChartType] = useState('line'); // ÂõæË°®Á±ªÂûãÔºö'candlestick' Êàñ 'line' - ÈªòËÆ§‰∏∫ÊäòÁ∫øÂõæ
  const currentPriceRef = useRef(currentPrice); // Áî®‰∫éÂú®ÂÆöÊó∂Âô®‰∏≠ËÆøÈóÆÊúÄÊñ∞‰ª∑Ê†º
  const updatePriceRef = useRef(updatePrice); // Áî®‰∫éÂú®ÂÆöÊó∂Âô®‰∏≠ËÆøÈóÆÊúÄÊñ∞ÁöÑupdatePriceÂáΩÊï∞

  // Token ÂàóË°®Êï∞ÊçÆ
  const tokenList = [
    {
      id: 'BTC',
      name: 'BTC-USD',
      icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/1.png',
      price: 115773.26,
      change: 0,
      changePercent: 0,
      payout: 175
    },
    {
      id: 'ETH',
      name: 'ETH-USD',
      icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/1027.png',
      price: 3715.3,
      change: 0,
      changePercent: 0,
      payout: 175
    },
    {
      id: 'BNB',
      name: 'BNB-USD',
      icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/1839.png',
      price: 770.479,
      change: -1.54,
      changePercent: -0.2,
      payout: 175
    },
    {
      id: 'SOL',
      name: 'SOL-USD',
      icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/5426.png',
      price: 180.421,
      change: -0.72,
      changePercent: -0.4,
      payout: 175
    },
    {
      id: 'TRUMP',
      name: 'TRUMP-USD',
      icon: 'https://s2.coinmarketcap.com/static/img/coins/64x64/1.png', // ‰ΩøÁî®BTCÂõæÊ†á‰Ωú‰∏∫Âç†‰ΩçÁ¨¶
      price: 9.9205,
      change: -0.04,
      changePercent: -0.4,
      payout: 175
    }
  ];

  // ‰ΩøÁî®Êñ∞ÁöÑÂ∏ÇÂú∫Êï∞ÊçÆÁîüÊàêÂô®
  const generateRealisticMockData = (basePriceOverride = null) => {
    const basePrice = basePriceOverride || currentPrice || 118735;
    return generateRealisticHistoricalData(basePrice, 61, 2000);
  };

  // Êõ¥Êñ∞refs
  useEffect(() => {
    currentPriceRef.current = currentPrice;
    updatePriceRef.current = updatePrice;
  }, [currentPrice, updatePrice]);

  // ÂàùÂßãÂåñÂõæË°®Êï∞ÊçÆ
  useEffect(() => {
    // Âè™Âú®ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÂàùÂßãÂåñ‰∏ÄÊ¨°
    if (chartData.length === 0) {
      const mockData = generateRealisticMockData();
      setChartData(mockData);
      const lastPrice = mockData[mockData.length - 1].close;

      // ËÆ°ÁÆó‰ª∑Ê†ºÂèòÂåñ
      const prevPrice = mockData[mockData.length - 2]?.close || lastPrice;
      const change = lastPrice - prevPrice;
      const changePercent = (change / prevPrice) * 100;

      // Êõ¥Êñ∞‰ª∑Ê†º‰∏ä‰∏ãÊñá
      updatePriceRef.current(lastPrice, change, changePercent);
      currentPriceRef.current = lastPrice; // ÂàùÂßãÂåñref

      // ÂàùÂßãÂåñÂÆûÊó∂tokenÊï∞ÊçÆ
      const initialTokenData = {};
      tokenList.forEach(token => {
        initialTokenData[token.id] = {
          price: token.price,
          changePercent: token.changePercent
        };
      });
      setRealTimeTokens(initialTokenData);
    }

    // Ê®°ÊãüÂÆûÊó∂Êï∞ÊçÆÊõ¥Êñ∞ - ÊØè1ÁßíÊõ¥Êñ∞‰ª∑Ê†ºÔºå‰∏éKÁ∫øÊï∞ÊçÆÂêåÊ≠•
    const interval = setInterval(() => {
      const prevPrice = currentPriceRef.current;

      // Ê†πÊçÆ‰ª∑Ê†ºÊ∞¥Âπ≥ËÆ°ÁÆóÂêàÁêÜÁöÑÊ≥¢Âä®Áéá
      let volatilityPercent;
      if (prevPrice > 50000) {
        volatilityPercent = 0.0005; // 0.05% - Â§ß‰ª∑Ê†ºÂ∏ÅÁßç
      } else if (prevPrice > 1000) {
        volatilityPercent = 0.001; // 0.1% - ‰∏≠Á≠â‰ª∑Ê†ºÂ∏ÅÁßç
      } else if (prevPrice > 10) {
        volatilityPercent = 0.002; // 0.2% - Â∞è‰ª∑Ê†ºÂ∏ÅÁßç
      } else {
        volatilityPercent = 0.003; // 0.3% - ÊûÅÂ∞è‰ª∑Ê†ºÂ∏ÅÁßç
      }

      const maxChange = prevPrice * volatilityPercent;
      const priceChange = (Math.random() - 0.5) * 2 * maxChange; // -maxChange Âà∞ +maxChange
      const newPrice = prevPrice + priceChange;
      const finalPrice = Math.max(prevPrice * 0.99, newPrice); // Á°Æ‰øùÂçïÊ¨°ÂèòÂåñ‰∏çË∂ÖËøá1%

      // Êõ¥Êñ∞ref
      currentPriceRef.current = finalPrice;

      // Êõ¥Êñ∞‰ª∑Ê†ºÂèòÂåñ
      const change = finalPrice - prevPrice;
      const changePercent = (change / prevPrice) * 100;

      // Êõ¥Êñ∞‰ª∑Ê†º‰∏ä‰∏ãÊñá
      updatePriceRef.current(finalPrice, change, changePercent);
    }, 1000); // Êîπ‰∏∫ÊØè1ÁßíÊõ¥Êñ∞‰ª∑Ê†ºÔºå‰∏éKÁ∫øÊï∞ÊçÆÂêåÊ≠•

    // Êõ¥Êñ∞ÊâÄÊúâtokenÁöÑÂÆûÊó∂‰ª∑Ê†º - ÊØè2ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°
    const tokenInterval = setInterval(() => {
      setRealTimeTokens(prev => {
        const updated = { ...prev };
        tokenList.forEach(token => {
          const currentData = prev[token.id] || { price: token.price, changePercent: token.changePercent };
          const volatility = token.price * 0.01; // Â¢ûÂä†Âà∞1% ÁöÑÊ≥¢Âä®ÊÄßÔºåËÆ©ÂèòÂåñÊõ¥ÊòéÊòæ
          const priceChange = (Math.random() - 0.5) * volatility;
          const newPrice = Math.max(0.01, currentData.price + priceChange);
          const changePercent = ((newPrice - token.price) / token.price) * 100;

          updated[token.id] = {
            price: newPrice,
            changePercent: changePercent
          };

          // Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑÊòØËøô‰∏™tokenÔºåÂêåÊó∂Êõ¥Êñ∞currentPriceRef
          if (selectedToken && selectedToken.id === token.id) {
            currentPriceRef.current = newPrice;
            // ÂêåÊó∂Êõ¥Êñ∞‰ª∑Ê†º‰∏ä‰∏ãÊñá
            const change = newPrice - currentData.price;
            const changePercentForContext = (change / currentData.price) * 100;
            updatePriceRef.current(newPrice, change, changePercentForContext);
          }
        });
        return updated;
      });
    }, 1000); // ÊØè1ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°

    // ÊØè1ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°KÁ∫øÊï∞ÊçÆ
    const candleInterval = setInterval(() => {
      setChartData(prevData => {
        const lastData = prevData[prevData.length - 1];

        // Ëé∑ÂèñÂΩìÂâçÂ∫îËØ•ÊòæÁ§∫ÁöÑ‰ª∑Ê†ºÔºà‰∏é‰ª∑Ê†º‰ø°ÊÅØÊ†è‰øùÊåÅ‰∏ÄËá¥Ôºâ
        let currentPriceValue;
        if (selectedToken) {
          // Â¶ÇÊûúÈÄâÊã©‰∫ÜtokenÔºå‰ΩøÁî®tokenÁöÑÂÆûÊó∂‰ª∑Ê†º
          currentPriceValue = realTimeTokens[selectedToken.id]?.price || selectedToken.price;
        } else {
          // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©tokenÔºå‰ΩøÁî®ÈªòËÆ§‰ª∑Ê†º
          currentPriceValue = currentPriceRef.current;
        }

        // Ê†πÊçÆÂΩìÂâç‰ª∑Ê†ºË∞ÉÊï¥Ê≥¢Âä®ÂπÖÂ∫¶
        const priceScale = currentPriceValue / 100000; // Âü∫‰∫é10‰∏á‰Ωú‰∏∫Âü∫ÂáÜ
        const volatilityMultiplier = Math.max(0.1, Math.min(2, priceScale)); // ÈôêÂà∂Âú®0.1-2ÂÄç‰πãÈó¥

        const newCandle = {
          time: Date.now(),
          open: lastData.close,
          high: Math.max(lastData.close, currentPriceValue) + Math.random() * 100 * volatilityMultiplier, // Ê†πÊçÆ‰ª∑Ê†ºË∞ÉÊï¥Ê≥¢Âä®
          low: Math.min(lastData.close, currentPriceValue) - Math.random() * 100 * volatilityMultiplier, // Ê†πÊçÆ‰ª∑Ê†ºË∞ÉÊï¥Ê≥¢Âä®
          close: currentPriceValue
        };

        // ‰øùÊåÅÊúÄËøë60‰∏™Êï∞ÊçÆÁÇπÔºà2ÂàÜÈíüÊï∞ÊçÆÔºâ
        const newData = [...prevData, newCandle];
        return newData.length > 60 ? newData.slice(-60) : newData;
      });
    }, 1000); // 1ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°

    return () => {
      clearInterval(interval);
      clearInterval(candleInterval);
      clearInterval(tokenInterval);
    };
  }, []); // ÁßªÈô§ÊâÄÊúâ‰æùËµñÔºåÂè™Âú®ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÊâßË°å‰∏ÄÊ¨°

  // ÁÆ°ÁêÜÊ¥ªË∑É‰∫§Êòì
  useEffect(() => {
    const interval = setInterval(() => {
      setActiveTrades(prevTrades => {
        return prevTrades.map(trade => {
          const elapsed = Date.now() - trade.startTime;
          if (elapsed >= 60000 && !trade.settled) {
            // 1ÂàÜÈíüÂà∞‰∫ÜÔºåÁªìÁÆó‰∫§Êòì
            // Ëé∑ÂèñÁªìÁÆóÊó∂ÁöÑ‰ª∑Ê†º
            let settlementPrice;
            if (selectedToken) {
              settlementPrice = realTimeTokens[selectedToken.id]?.price || selectedToken.price;
            } else {
              settlementPrice = currentPriceRef.current;
            }

            const isWin = trade.direction === 'up'
              ? settlementPrice > trade.entryPrice
              : settlementPrice < trade.entryPrice;

            const profit = isWin ? trade.amount * payout : -trade.amount;
            setBalance(prev => prev + profit);

            // ËæìÂá∫ÁªìÁÆó‰ø°ÊÅØÂà∞ÊéßÂà∂Âè∞
            const directionText = trade.direction === 'up' ? 'ÁúãÊ∂®' : 'ÁúãË∑å';
            const priceChange = settlementPrice - trade.entryPrice;
            const priceChangePercent = (priceChange / trade.entryPrice * 100).toFixed(2);

            console.log(`üèÅ ‰∫§ÊòìÁªìÁÆóÂÆåÊàêÔºÅ`);
            console.log(`üìä ÁªìÁÆóËØ¶ÊÉÖ:`);
            console.log(`   - ‰∫§ÊòìÊñπÂêë: ${directionText}`);
            console.log(`   - ‰π∞ÂÖ•‰ª∑Ê†º: $${trade.entryPrice.toFixed(4)}`);
            console.log(`   - ÁªìÁÆó‰ª∑Ê†º: $${settlementPrice.toFixed(4)}`);
            console.log(`   - ‰ª∑Ê†ºÂèòÂåñ: ${priceChange > 0 ? '+' : ''}${priceChange.toFixed(4)} (${priceChangePercent}%)`);
            console.log(`   - ‰∫§ÊòìÁªìÊûú: ${isWin ? '‚úÖ ÁõàÂà©' : '‚ùå ‰∫èÊçü'}`);
            console.log(`   - Áõà‰∫èÈáëÈ¢ù: ${profit > 0 ? '+' : ''}$${profit}`);
            console.log(`   - ÂΩìÂâç‰ΩôÈ¢ù: $${balance + profit}`);

            return {
              ...trade,
              settled: true,
              result: isWin ? 'win' : 'loss',
              profit,
              settlementPrice,
              settlementTime: Date.now()
            };
          }
          return trade;
        }).filter(trade => Date.now() - trade.startTime < 120000); // 2ÂàÜÈíüÂêéÁßªÈô§
      });
    }, 1000);

    return () => clearInterval(interval);
  }, [currentPrice, payout]);

  const handleTrade = (direction) => {
    if (tradeAmount <= 0) {
      console.log('‚ùå ‰∫§ÊòìÂ§±Ë¥•: ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ‰∫§ÊòìÈáëÈ¢ù');
      return;
    }

    if (balance < tradeAmount) {
      console.log('‚ùå ‰∫§ÊòìÂ§±Ë¥•: ‰ΩôÈ¢ù‰∏çË∂≥');
      return;
    }

    // ÂàõÂª∫Êñ∞‰∫§Êòì - ‰ΩøÁî®‰∏é‰ª∑Ê†º‰ø°ÊÅØÊ†è‰∏ÄËá¥ÁöÑ‰ª∑Ê†º
    let entryPrice;
    if (selectedToken) {
      // Â¶ÇÊûúÈÄâÊã©‰∫ÜtokenÔºå‰ΩøÁî®tokenÁöÑÂÆûÊó∂‰ª∑Ê†º
      entryPrice = realTimeTokens[selectedToken.id]?.price || selectedToken.price;
    } else {
      // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©tokenÔºå‰ΩøÁî®ÂΩìÂâç‰ª∑Ê†º
      entryPrice = currentPriceRef.current;
    }

    const newTrade = {
      id: Date.now(),
      direction,
      amount: tradeAmount,
      entryPrice: entryPrice,
      startTime: Date.now(),
      settled: false
    };

    setActiveTrades(prev => [...prev, newTrade]);
    setBalance(prev => prev - tradeAmount); // Êâ£Èô§‰∫§ÊòìÈáëÈ¢ù

    // ËæìÂá∫‰∫§Êòì‰ø°ÊÅØÂà∞ÊéßÂà∂Âè∞
    const directionText = direction === 'up' ? 'ÁúãÊ∂®' : 'ÁúãË∑å';
    console.log(`‚úÖ ${directionText} ‰∫§ÊòìÂ∑≤Êèê‰∫§ÔºÅ`);
    console.log(`üìä ‰∫§ÊòìËØ¶ÊÉÖ:`);
    console.log(`   - ÊñπÂêë: ${directionText}`);
    console.log(`   - ÈáëÈ¢ù: $${tradeAmount}`);
    console.log(`   - ÂÖ•Âú∫‰ª∑Ê†º: $${entryPrice.toFixed(4)}`);
    console.log(`   - ÁªìÁÆóÊó∂Èó¥: 1ÂàÜÈíü`);
    console.log(`   - ‰∫§ÊòìID: ${newTrade.id}`);
    console.log(`   - Ââ©‰Ωô‰ΩôÈ¢ù: $${balance - tradeAmount}`);
  };

  // ÈÄâÊã© token Â§ÑÁêÜÂáΩÊï∞
  const handleTokenSelect = (token) => {
    setSelectedToken(token);
    setShowTokenList(false);

    // ÈáçÊñ∞ÁîüÊàêÂü∫‰∫éËØ•token‰ª∑Ê†ºÁöÑKÁ∫øÊï∞ÊçÆ
    const tokenPrice = realTimeTokens[token.id]?.price || token.price;
    const newChartData = generateTokenHistoricalData({ price: tokenPrice, id: token.id });
    setChartData(newChartData);

    // Á´ãÂç≥Êõ¥Êñ∞currentPriceRef‰∏∫ÈÄâ‰∏≠tokenÁöÑ‰ª∑Ê†ºÔºåÁ°Æ‰øùÂêåÊ≠•
    currentPriceRef.current = tokenPrice;

    // Êõ¥Êñ∞‰ª∑Ê†º‰∏ä‰∏ãÊñá
    const tokenData = realTimeTokens[token.id] || { price: token.price, changePercent: token.changePercent };
    const change = tokenData.price - token.price;
    updatePriceRef.current(tokenPrice, change, tokenData.changePercent);
  };

  // ËøîÂõû token ÂàóË°®
  const handleBackToTokenList = () => {
    setShowTokenList(true);
    setSelectedToken(null);

    // ÈáçÊñ∞ÁîüÊàêÈªòËÆ§ÁöÑKÁ∫øÊï∞ÊçÆ
    const newChartData = generateRealisticMockData();
    setChartData(newChartData);

    // ÈáçÁΩÆ‰∏∫ÈªòËÆ§‰ª∑Ê†º
    const defaultPrice = newChartData[newChartData.length - 1].close;
    currentPriceRef.current = defaultPrice;
    updatePriceRef.current(defaultPrice, 0, 0);
  };

  // Ê∏≤Êüì token ÂàóË°®
  const renderTokenList = () => (
    <div className="space-y-3 p-4">
      <h2 className="text-2xl font-bold text-white mb-6">Markets</h2>
      {tokenList.map((token) => (
        <div
          key={token.id}
          onClick={() => handleTokenSelect(token)}
          className="flex items-center justify-between p-4 rounded-lg cursor-pointer hover:bg-opacity-80 transition-all"
          style={{ backgroundColor: 'var(--color-bg-secondary)' }}
        >
          <div className="flex items-center">
            <div className="w-10 h-10 rounded-full overflow-hidden flex-shrink-0" style={{ marginRight: '16px' }}>
              <img
                src={token.icon}
                alt={token.name}
                className="w-full h-full object-cover"
                onError={(e) => {
                  e.target.src = 'https://s2.coinmarketcap.com/static/img/coins/64x64/1.png';
                }}
              />
            </div>
            <div className="flex flex-col justify-center" style={{ height: '40px' }}>
              <div className="text-white font-medium text-lg leading-tight">{token.name}</div>
              <div className="text-xs leading-tight" style={{ color: '#8f8f8f' }}>Payout: {token.payout}%</div>
            </div>
          </div>
          <div style={{ textAlign: 'right' }}>
            {(() => {
              const realTimeData = realTimeTokens[token.id] || { price: token.price, changePercent: token.changePercent };
              return (
                <>
                  <div className="text-white font-medium text-lg" style={{ textAlign: 'right' }}>
                    {realTimeData.price.toLocaleString(undefined, {
                      minimumFractionDigits: token.price < 1 ? 4 : 2,
                      maximumFractionDigits: token.price < 1 ? 4 : 2
                    })}
                  </div>
                  <div className="text-sm" style={{ textAlign: 'right' }}>
                    {realTimeData.changePercent !== 0 ? (
                      <span style={{
                        color: realTimeData.changePercent > 0 ? '#10b981' : '#ef4444'
                      }}>
                        {realTimeData.changePercent > 0 ? '‚ñ≤' : '‚ñº'} {Math.abs(realTimeData.changePercent).toFixed(2)}%
                      </span>
                    ) : (
                      <span style={{ color: '#8f8f8f' }}>0%</span>
                    )}
                  </div>
                </>
              );
            })()}
          </div>
        </div>
      ))}
    </div>
  );

  return (
    <div className="min-h-screen text-white overflow-x-hidden w-full" style={{ backgroundColor: 'var(--color-bg-primary)' }}>
      {/* ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü - Ê∑ªÂä†È°∂ÈÉ®ËæπË∑ùÈÅøÂÖçË¢´navbarÊå°‰Ωè */}
      <div className="mobile-container" style={{ paddingTop: '64px' }}>

        {/* Â¶ÇÊûúÊòæÁ§∫ token ÂàóË°® */}
        {showTokenList ? (
          renderTokenList()
        ) : (
          <>
            {/* ‰∫§ÊòìÈ°µÈù¢ÂÜÖÂÆπ */}
        {/* ‰ª∑Ê†º‰ø°ÊÅØÊ†è */}
        <div className="flex items-center justify-between p-4 border-b border-gray-800 w-full" style={{ backgroundColor: 'var(--color-bg-primary)' }}>
          <div className="flex items-center">
            {!showTokenList && (
              <div
                onClick={handleBackToTokenList}
                className="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 transition-colors hover:opacity-80"
                style={{ backgroundColor: 'var(--color-bg-secondary)', color: 'white', fontSize: '16px', marginRight: '12px' }}
              >
                ‚Üê
              </div>
            )}
            {selectedToken && (
              <div className="flex items-center">
                <div className="w-10 h-10 rounded-full overflow-hidden flex-shrink-0" style={{ marginRight: '12px' }}>
                  <img
                    src={selectedToken.icon}
                    alt={selectedToken.name}
                    className="w-full h-full object-cover"
                    onError={(e) => {
                      e.target.src = 'https://s2.coinmarketcap.com/static/img/coins/64x64/1.png';
                    }}
                  />
                </div>
                <div className="flex flex-col justify-center" style={{ height: '32px' }}>
                  <div className="text-white font-medium leading-tight">{selectedToken.name}</div>
                  <div className="leading-tight" style={{ color: '#8f8f8f', fontSize: '10px' }}>Binary Options</div>
                </div>
              </div>
            )}
          </div>

          {selectedToken && (
            <div style={{ textAlign: 'right' }}>
              {(() => {
                const realTimeData = realTimeTokens[selectedToken.id] || { price: selectedToken.price, changePercent: selectedToken.changePercent };
                return (
                  <>
                    <div className="text-2xl font-normal" style={{ textAlign: 'right' }}>
                      {realTimeData.price.toLocaleString(undefined, {
                        minimumFractionDigits: selectedToken.price < 1 ? 4 : 2,
                        maximumFractionDigits: selectedToken.price < 1 ? 4 : 2
                      })}
                    </div>
                    <div className="text-sm" style={{ textAlign: 'right', display: 'flex', alignItems: 'center', justifyContent: 'flex-end', gap: '8px' }}>
                      {realTimeData.changePercent !== 0 ? (
                        <span style={{
                          color: realTimeData.changePercent > 0 ? '#10b981' : '#ef4444'
                        }}>
                          {realTimeData.changePercent > 0 ? '‚ñ≤' : '‚ñº'} {Math.abs(realTimeData.changePercent).toFixed(2)}%
                        </span>
                      ) : (
                        <span style={{ color: '#8f8f8f' }}>0%</span>
                      )}
                      <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                        <div
                          className="w-2 h-2 rounded-full animate-pulse"
                          style={{
                            backgroundColor: realTimeData.changePercent > 0 ? '#10b981' :
                                           realTimeData.changePercent < 0 ? '#ef4444' : '#8f8f8f'
                          }}
                        ></div>
                        <span className="text-xs" style={{ color: '#8f8f8f' }}>ÂÆûÊó∂</span>
                      </div>
                    </div>
                  </>
                );
              })()}
            </div>
          )}
        </div>

      {/* ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü */}
      <div>
        {/* ÂõæË°®Âå∫Âüü */}
        <div className="h-96 relative w-full overflow-hidden">
          <TradingChart
            data={chartData}
            currentPrice={selectedToken ? (realTimeTokens[selectedToken.id]?.price || selectedToken.price) : currentPrice}
            activeTrades={activeTrades}
            chartType={chartType}
          />
        </div>

        {/* ÂõæË°®Á±ªÂûãÂàáÊç¢ÊåâÈíÆ - ÊöÇÊó∂ÈöêËóèÔºåÂè™ÊòæÁ§∫ÊäòÁ∫øÂõæ */}
        {/*
        <div className="flex justify-center py-4 border-b" style={{
          backgroundColor: 'var(--color-bg-primary)',
          borderColor: 'var(--color-border)'
        }}>
          <div className="flex rounded-lg overflow-hidden" style={{ backgroundColor: 'var(--color-bg-secondary)' }}>
            <div
              onClick={() => setChartType('candlestick')}
              className={`px-4 py-2 text-sm font-medium transition-all rounded-r-lg ${
                chartType === 'candlestick'
                  ? 'text-black'
                  : 'text-gray-400 hover:text-white'
              }`}
              style={{
                backgroundColor: chartType === 'candlestick' ? '#eaae36' : 'transparent'
              }}
            >
              KÁ∫øÂõæ
            </div>
            <div
              onClick={() => setChartType('line')}
              className={`px-4 py-2 text-sm font-medium transition-all rounded-l-lg ${
                chartType === 'line'
                  ? 'text-black'
                  : 'text-gray-400 hover:text-white'
              }`}
              style={{
                backgroundColor: chartType === 'line' ? '#eaae36' : 'transparent'
              }}
            >
              ÊäòÁ∫øÂõæ
            </div>
          </div>
        </div>
        */}

        {/* Â∫ïÈÉ®‰∫§ÊòìÈù¢Êùø */}
        <div className="border-t p-4 w-full" style={{
          backgroundColor: 'var(--color-bg-secondary)',
          borderColor: 'var(--color-border)',
          paddingBottom: '80px'  // ‰∏∫Â∫ïÈÉ®Ê†èÁïôÂá∫Á©∫Èó¥
        }}>
          <div className="w-full space-y-4">
            {/* ‰∫§ÊòìÈáëÈ¢ù */}
            <div>
              <div className="text-gray-400 text-sm mb-2">Trade Amount</div>
              <div className="flex gap-2 w-full justify-between">
                <input
                  type="number"
                  value={tradeAmount}
                  onChange={(e) => setTradeAmount(Number(e.target.value))}
                  className="flex-1 text-white text-2xl font-normal px-4 py-3 rounded-lg border focus:outline-none min-w-0"
                  style={{
                    backgroundColor: 'var(--color-input-bg)',
                    borderColor: 'var(--color-border)'
                  }}
                  min="1"
                />
                <div
                  onClick={() => setShowCurrencyModal(true)}
                  className="flex items-center px-4 py-3 rounded-lg border cursor-pointer hover:border-gray-600 transition-colors flex-shrink-0"
                  style={{
                    backgroundColor: 'var(--color-input-bg)',
                    borderColor: 'var(--color-border)'
                  }}
                >
                  <span className="text-white font-medium text-lg">{selectedCurrency}</span>
                  <svg width="16" height="16" fill="none" stroke="#8f8f8f" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" className="ml-2">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                  </svg>
                </div>
              </div>

              {/* ÈáëÈ¢ùÊªëÂùó */}
              <div className="mt-6 mb-4">
                <input
                  type="range"
                  min="1"
                  max="100"
                  value={tradeAmount}
                  onChange={(e) => setTradeAmount(Number(e.target.value))}
                  className="w-full rounded-lg appearance-none cursor-pointer slider"
                  style={{
                    height: '10px',
                    background: `linear-gradient(to right, var(--color-accent) 0%, var(--color-accent) ${tradeAmount}%, var(--color-slider-bg) ${tradeAmount}%, var(--color-slider-bg) 100%)`
                  }}
                />
                <div className="flex justify-between text-xs mt-2" style={{ color: '#8f8f8f' }}>
                  <span>1</span>
                  <span>100</span>
                </div>
              </div>
            </div>

            {/* ‰ΩôÈ¢ùÊòæÁ§∫ */}
            <div className="flex justify-between items-center text-sm">
              <span style={{ color: '#8f8f8f' }}>Balance: {balance.toFixed(2)}</span>
              <span style={{ color: '#8f8f8f' }}>Payout: {payout}</span>
            </div>

            {/* ‰∫§ÊòìÊåâÈíÆ */}
            <div className="flex justify-between gap-3 w-full">
              <div
                onClick={() => handleTrade('up')}
                className="font-normal py-4 px-6 rounded-xl transition-all flex items-center justify-center gap-2 text-white"
                style={{ backgroundColor: '#10b981', width: '180px' }}
                onMouseEnter={(e) => e.target.style.backgroundColor = '#059669'}
                onMouseLeave={(e) => e.target.style.backgroundColor = '#10b981'}
              >
                <svg width="20" height="20" fill="none" stroke="#ffffff" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 17l9.2-9.2M17 17V7H7" />
                </svg>
                <span>Up</span>
              </div>

              <div className="flex flex-col items-center justify-center px-4">
                <div className="text-gray-400 text-xs">1m</div>
                <svg width="24" height="24" fill="none" stroke="#8f8f8f" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>

              <div
                onClick={() => handleTrade('down')}
                className="font-normal py-4 px-6 rounded-xl transition-all flex items-center justify-center gap-2 text-white"
                style={{ backgroundColor: '#ef4444', width: '180px' }}
                onMouseEnter={(e) => e.target.style.backgroundColor = '#dc2626'}
                onMouseLeave={(e) => e.target.style.backgroundColor = '#ef4444'}
              >
                <svg width="20" height="20" fill="none" stroke="#ffffff" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 7l-9.2 9.2M7 7v10h10" />
                </svg>
                <span>Down</span>
              </div>
            </div>
          </div>
        </div>
      </div>

            {/* Ë¥ßÂ∏ÅÈÄâÊã©ÂºπÁ™ó */}
            <CurrencyModal
              isOpen={showCurrencyModal}
              onClose={() => setShowCurrencyModal(false)}
              selectedCurrency={selectedCurrency}
              onSelect={(currency) => {
                setSelectedCurrency(currency);
                setShowCurrencyModal(false);
              }}
            />
          </>
        )}
      </div>
    </div>
  );
};

export default Trading;
